#!/bin/bash

set -euo pipefail

NOW=$(date)
echo "Starting backup at ${NOW}"

LOCK_FILE="/tmp/crawler-backup.lock"

cleanup() {
	echo "Removing lock file..."
	rm -f "$LOCK_FILE"

	echo "Removing *.sqlite files..."
	rm -f /tmp/*.db.backup

	echo "Done!  Exiting..."
}

if [ -e $LOCK_FILE ]; then
	echo "Lock file exists, not starting another backup"
	exit 1
fi

trap cleanup EXIT

touch $LOCK_FILE

# 900 second timeout to wait for a lock release, because writing crawler data takes a long time usually
timeout=900000

echo "Starting backup..."
sqlite3 {{ chia_root }}/crawler.db <<EOF
.timeout $timeout
.backup '/tmp/crawler.db.backup'
EOF

echo "Starting database upload to s3..."
aws --no-progress s3 cp "/tmp/crawler.db.backup" "s3://{{ blockchain_backup_bucket }}/{{ network }}/crawler.db"

echo "Backup Complete!"
