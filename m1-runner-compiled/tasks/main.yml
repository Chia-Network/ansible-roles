---
# chia-runner/tasks/main.yml
- name: Make .zshenv or verify that it exists
  ansible.builtin.file:
    path: "~/.zshenv"
    mode: '0755'
    state: touch

- name: Insert the proper path for gnu-tar in .zshenv.
  lineinfile:
    path: "~/.zshenv"
    line: export PATH=/opt/homebrew/opt/gnu-tar/libexec/gnubin:$PATH
    regexp: '^export.PATH=/opt/homebrew/opt/gnu-tar'
    insertbefore: EOF

- name: Insert the proper path for homebrew bin in .zshenv.
  lineinfile:
    path: "~/.zshenv"
    line: export PATH=/opt/homebrew/bin:$PATH
    regexp: '^export.PATH=/opt/homebrew/bin'
    insertbefore: EOF

- name: Insert the proper path for homebrew sbin in .zshenv.
  lineinfile:
    path: "~/.zshenv"
    line: export PATH=/opt/homebrew/sbin:$PATH
    regexp: '^export.PATH=/opt/homebrew/sbin'
    insertbefore: EOF

- name: Insert the proper path for cargo in .zshenv.
  lineinfile:
    path: "~/.zshenv"
    line: export PATH=/Users/chia/.cargo/bin:$PATH
    regexp: '^export.PATH=/Users/chia/.cargo'
    insertbefore: EOF

- name: Check out the repo to compile
  ansible.builtin.git:
    repo: "{{ runner_repo_url }}"
    dest: "{{ runner_directory_path }}"
    version: "{{ runner_repo_ref }}"
    update: yes
    force: yes
  register: git_output
  notify: restart-runner-service

- name: Compile runner
  shell: |
    ./dev.sh layout
  args:
    chdir: "{{ runner_directory_path }}/src"
  when: git_output.changed

- name: Configure the runner for GitHub
  shell: ./config.sh --url https://github.com/Chia-Network --token "{{ runner_registration_token }}" --runnergroup "{{ runner_github_group }}" --labels "{{ runner_tags }}" --name "{{ inventory_hostname }}" --unattended
  args:
    chdir: "{{ runner_directory_path }}/_layout"
    creates: "{{ runner_directory_path }}/_layout/.runner"
  register: configure
- debug:
    msg: "{{ configure.stdout }}"

- name: Install the runner service
  shell: |
    ./svc.sh install
  args:
    chdir: "{{ runner_directory_path }}/_layout"
    creates: "~/Library/LaunchAgents/actions.runner.Chia-Network.{{ inventory_hostname }}.plist"
  register: install
- debug:
    msg: "{{ install.stdout }}"

- name: Start the runner service
  shell: |
    ./svc.sh start
    ./svc.sh status
  args:
    chdir: "{{ runner_directory_path }}/_layout"
  register: output
- debug:
    msg: "{{ output.stdout }}"

- name: Move .path to actions-runner directory
  template:
    src: .path
    dest: "{{ runner_directory_path }}/_layout"
